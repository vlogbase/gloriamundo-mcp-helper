# -------- BEGIN WORKFLOW --------
name: Build & Publish MCP Helper

on:
  push:
    tags: ['v*']          # fire only on version tags

permissions:
  contents: write         # needed by softprops/action-gh-release

jobs:
  build:
    name: ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}

    strategy:
      matrix:
        include:
          # runner           os     arch   pkgTarget               ext
          - { runner: ubuntu-latest , os: linux ,  arch: x64  , pkgTarget: node20-linux-x64   , ext: ""     }
          - { runner: ubuntu-latest , os: linux ,  arch: arm64, pkgTarget: node20-linux-arm64 , ext: ""     }
          - { runner: macos-latest  , os: macos , arch: x64  , pkgTarget: node20-macos-x64   , ext: ""     }
          - { runner: macos-latest  , os: macos , arch: arm64, pkgTarget: node20-macos-arm64 , ext: ""     }
          - { runner: windows-latest, os: win   , arch: x64  , pkgTarget: node20-win-x64    , ext: ".exe" }

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps & build
        run: |
          npm ci
          npm run build        # creates dist/host.js

      - name: Package binary
        run: |
          npx pkg dist/host.js \
            --targets ${{ matrix.pkgTarget }} \
            --output dist/pkg/gm-mcp-host-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }}

      - name: Upload binary
        uses: softprops/action-gh-release@v2
        with:
          files: dist/pkg/gm-mcp-host-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }}
# -------- END WORKFLOW --------
